#!/usr/bin/env variant
# vi: ft=yaml

tasks:
  init:
    steps:
      - task: cloud.gcp.gcloud.auth.activate-service-account
      - task: cloud.gcp.gcloud.container.clusters.get-credentials

  auth:
    tasks:
      activate-service-account:
        autoenv: true
        steps:
        - task: core.exec
          arguments:
            title: "Google Cloud :: Set project & activate service account"
            cmd: |
              gcloud config set project {{ .CLOUDSDK_CORE_PROJECT }}
              gcloud auth activate-service-account --key-file={{ .TOOLBOX_GCP_KEY_FILE }}

  container:
    tasks:
      clusters:
        autoenv: true
        tasks:
          get-credentials:
            autoenv: true
            steps:
            - task: core.exec
              arguments:
                title: "Google Cloud :: Cluster :: Get credentials"
                cmd: |
                  gcloud container clusters get-credentials {{ .CLOUDSDK_CONTAINER_CLUSTER }}

